title Loan Execution

participant "Market Maker (browser)" as Maker
participant "Filecoin (network)" as Filecoin
participant "Market (contract)" as Market
participant "Collateral (contract)" as Collateral
participant "Loan (contract)" as Loan
participant "Market Taker(browser)" as Taker

note over Maker,Taker:Loan Execution

Market<--Taker: Read market data
Loan<-Taker:New Loan Registration
Collateral<-Loan:Check Collateral\nCollateral state: AVAILABLE
note over Collateral: AVAILABLE
Market<-Loan:Update booking board\nadjust the deal size
Loan->Loan:Loan state: REGISTERED
note over Loan: REGISTERED
Loan-->Taker:Emit message\n'Loan REGISTERED'\nor revert
Maker<--Loan:Emit message\n'Loan REGISTERED'
Maker->Filecoin: Transfer Filecoin (FIL)
Maker->Loan: Input Filecoin txHash
Loan-->Taker: Emit message\n'Fund ARRIVED'
Taker-->Filecoin: Verify the amount from txHash
Taker->Loan:Confirm the amount\nLoan state: WORKING
note over Loan:WORKING
Loan-->Maker: Emit message\n'Loan BEGIN'
Loan->Collateral: Collateral state: IN USE
note over Collateral: IN USE
Collateral-->Taker: Emit message\n'Collateral IN USE'