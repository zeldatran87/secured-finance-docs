title Margin Call

participant "Market (contract)" as Market
participant "Collateral (contract)" as Collateral
participant "Scheduler (server, browser)" as Scheduler
participant "Loan (contract)" as Loan
participant "Market Taker (browser)" as Taker

note over Market,Taker:Margin Call Operations

note over Loan: WORKING
note over Collateral: IN USE
Scheduler->Loan:Call update all PV method
Market<--Loan:View yield curve
Loan->Loan:Calc PV of loans
Loan->Collateral: Update coverage (< 150%)\nstate 'MARGIN CALL'
note over Collateral: MARGINCALL
Collateral-->Taker: Emit message\n'MARGIN CALL'

note over Market,Taker:Safe case

Taker->Collateral: Send ETH to\nupsize colalteral
Collateral->Loan:Call update user PV method
Market<--Loan:View yield curve
Loan->Loan:Calc PV of loans
Collateral<-Loan:Update coverage (>150%)\nstate 'IN USE'
note over Collateral: IN USE
Collateral-->Taker: Emit message\n'margin SAFE'

note over Market,Taker:Liquidation case

Taker-->Taker: No ETH
Loan-->Loan: Wait for action
Scheduler->Loan:Call update all PV method
Market<--Loan:View yield curve
Loan->Loan:Calc PV of loans
Collateral<-Loan:Update coverage (<125%)\nstate 'LIQUIDATION'
note over Collateral: LIQUIDATION
Collateral-->Taker: Emit message\n'Collateral Liquidation'
