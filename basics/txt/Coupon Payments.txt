title Coupon Payments

participant "Lender (browser)" as Lender
participant "Market Maker(browser)" as Maker
participant "Collateral (contract)" as Collateral
participant "Filecoin (network)" as Filecoin
participant "Loan (contract)" as Loan
participant "Market Taker (browser)" as Taker

note over Lender,Taker:Coupon Payments
note over Loan: WORKING
Loan->Loan: Check payment schedule\n Loan state 'DUE'
note over Loan: DUE
Loan-->Taker:Emit message 'Payment Advice'

note over Lender,Taker:Safe Case

note over Collateral: IN USE
Taker->Filecoin: Transfer Filecoin (FIL)
Taker->Loan: Input Filecoin txHash
Loan-->Lender:Emit message:\n'FIL Coupon Paid'
Lender-->Filecoin: Verify the amount from txHash
Lender->Loan:Confirm FIL payment\nLoan state 'WORKING'
note over Loan: WORKING
Loan-->Taker: Emit message\n'Coupon Paid'

note over Lender,Taker:Liquidation Case

note over Loan: DUE 
note over Collateral: IN USE
Taker-->Taker: No Payment
Loan->Collateral: Update the collateral\nstate 'PARTIAL LIQUIDATION'
note over Collateral: PARTIAL LIQUIDATION
Collateral-->Taker: Emit message 'Collateral Partial Liquidation'
Collateral-->Lender: Emit message 'Collateral Partial Liquidation'
Collateral-->Maker:Emit message 'Nominated\nas partial liquidation provider'
Maker->Filecoin: Transfer Filecoin (FIL)
Maker->Loan: Input Filecoin txHash
Loan-->Lender:Emit message:\n'FIL Coupon Paid'
Lender-->Filecoin: Verify the amount from txHash
Lender->Collateral:Confirm FIL paid\nCollateral state 'IN USE'
note over Collateral: IN USE
Collateral->Maker: Release collateral for\nFIL coupon amt (in ETH120%)
Collateral-->Collateral: Reserve (ETH 5%)\nmanagement fee
Collateral->Loan:Loan state 'WORKING'
note over Loan: WORKING
Loan-->Taker: Emit message\n'Coupon Paid'
