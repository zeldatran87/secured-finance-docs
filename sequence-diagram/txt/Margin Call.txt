title Margin Call

participant "Market (contract)" as Market
participant "Collateral (contract)" as Collateral
participant "Scheduler (server)" as Scheduler
participant "Loan (contract)" as Loan
participant "Market Taker (browser)" as Taker

note over Market,Taker:Margin Call Operations

Scheduler->Loan: Call calc all PV method
Market<--Loan:View yield curve
Loan->Loan:Calc PV of loans
Loan-->Collateral: Read collateral info\nand calc coverage \n(< 150%)
Collateral<-Loan: Update the collateral\n state 'MARGIN CALL'
Collateral-->Taker: Emit message\n'MARGIN CALL'

note over Market,Taker:Safe case

Taker->Collateral: Send ETH to\nupsize colalteral
Market<--Loan:View yield curve
Loan->Loan:Calc PV of loans
Loan-->Collateral: Read collateral info\nand calc coverage \n(>150%)
Collateral<-Loan:Update the collateral\nstate 'IN USE'
Collateral-->Taker: Emit message\n'margin SAFE'

note over Market,Taker:Liquidation case

Taker-->Taker: No ETH
Loan-->Loan: Wait for action
Market<--Loan:View yield curve
Loan->Loan:Calc PV of loans
Loan-->Collateral: Read collateral info\nand calc coverage \n(<125%)
Collateral<-Loan:Update the collateral\nstate 'LIQUIDATION'
Collateral-->Taker: Emit message\n'Collateral Liquidation'
